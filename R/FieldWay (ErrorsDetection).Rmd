---
title: "FieldWay (ErrorsDetection)"
author: "Vincyane Badouard"
date: "29/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Objective: Detect errors
- Check *duplicated TreeFieldNum* in plot-subplot association
- Check of the *unique association of the idTree with plot, subplot and TreeFieldNum*
- Check *duplicated idTree* in a census
- Check *missing value* (NA/NULL/0) of tree size
- Check for *missing coordinates*
- Check for trees *outside the subplot*
- Missing values in other columns (Plot, SubPlot, Time, TreeFieldNum, IdTree, LifeStatus, POM)
- Check *missing trees* compared to the previous census (add rows) (idTree absent of the last census, but alive at the previous census)
- Check *invariant columns*: "Plot","SubPlot","TreeFieldNum","X","Y" for a unique "idTree"

Internals:
- Bota
- Life status
- Diameter
- Recruitment

-> Create a comment ("Comment" column) to inform about the error type.

# Packages libraries
```{r, include = FALSE}
library(TreeData)
library(data.table)
```


# Import data & other inputs
```{r}
data("TestData") # import data
# INPUTS
Data = TestData
## data.frame to data.table
setDT(Data) # with "set" "<-" is not necessary

Plot = "SubPlot"
SubPlot = "SubSubPlot"
Time = "CensusYear"
TreeFieldNum = "TreeFieldNum"
IdTree = "idTree"
LifeStatus = "CodeAlive"
Size = "Circ"
SizeUnit = "m"
POM = "MeasCode"
POMUnit = "code" # NULL
PlotArea = "PlotArea"
X = "Xutm"
Y = "Yutm"
ScientificName = "none" # NULL
VernName = "none" # NULL
Family = "Family"
Genus = "Genus"
Species = "Species"
CommercialSp = "CommercialSp"
TreeHeight = "none" # NULL
TreeHeightUnit = "none" # NULL

# Environment
# list with new names for the object in arguments (to avoid conflict and work with user variables names)
env <- lapply(list(.Plot = Plot,
                   .SubPlot = SubPlot,
                   .Time = Time,    # if it's a vector as.name keeps only the first column name
                   .TreeFieldNum = TreeFieldNum,
                   .IdTree = IdTree,
                   .LifeStatus = LifeStatus,
                   .Size = Size,
                   .POM = POM,
                   .PlotArea = PlotArea,
                   .X = X,
                   .Y = Y,
                   .ScientificName = ScientificName,
                   .VernName = VernName,
                   .Family = Family,
                   .Genus = Genus,
                   .Species = Species,
                   .CommercialSp = CommercialSp,
                   .TreeHeight = TreeHeight
), as.name) # refer to R object by their name. Doesn't work if the value is NULL
```


# Multiple checks

## Missing values
Plot, SubPlot, Time, TreeFieldNum, IdTree, X, Y
If the column exists, but have NA values
```{r}
Vars <- c(Plot, SubPlot, Time, TreeFieldNum, IdTree, LifeStatus, Size, POM, X, Y) # col names (chr)

v =6
for (v in 1:length(Vars)) {
  
  if(Vars[v] %in% names(Data)){ # If the column exists
    
    Data[is.na(Vars[v]), "Comment" := paste0("Missing value in ", Vars[v])] # comments
    
  }
}


# Check for missing coordinates
# missing_coor <- Data[is.na(get(X)) | is.na(get(Y))] # transformer en 1 vect
# if(any(missing_coor)){
#   
#   Data[missing_coor, Comment := paste0("Missing coordinates: ",X,", ",Y)]
# }
```

## Check duplicated TreeFieldNum in plot-subplot association
```{r}

```

## Check of the unique association of the idTree with plot, subplot and TreeFieldNum
```{r}
# Check of the unique association of the idTree with plot, subplot and TreeFieldNum

correspondances <- na.omit(unique(Data[, c(IdTree, Plot, SubPlot, TreeFieldNum), with = FALSE])) # with=F: the column names can be used as variables

CorresIDs <- correspondances[, IdTree, with = FALSE] # all the possible idtree's


if(!identical(CorresIDs, unique(CorresIDs))){ # check if it's the same lenght, same ids -> 1 asso/ID
  
  Data[duplicated(CorresIDs),
       Comment := paste0("Non-unique association of the ",IdTree," with " ,Plot,", ",SubPlot," and " ,TreeFieldNum)]
  
}


```

## Check duplicated idTree in a census
```{r}
# Separate the data per census
# Data2016 <- Data[Time == 2016]

# Check duplicated idTree in a census
ids <- apured_trees$idTree[!is.na(apured_trees$idTree)] # Take care of excluding NAs

if(anyDuplicated(ids) != 0){
  # Extract the duplicated ids - Unique, just in case there is more than two measured for these ids.
  duplicated_ids <- unique(ids[duplicated(ids)])
  
  Data[apured_trees$idTree %in% duplicated_ids, Comment := paste0("Duplicated ",IdTree," in the census")]
  
}
```
## Check for trees outside the subplot
```{r}
# Check for trees outside the subplot

```
## Check missing trees compared to the previous census (add rows)
*Missing tree* = idTree absent of the last census, but alive at the previous census.
```{r}
# Check missing trees compared to the previous census (add rows)
LastTime <- max(Data[,get(Time)]) # Last census year
LastCens <- Data[get(Time) == LastTime]
PreviousTime <- max(unique(Data[get(Time) < LastTime, get(Time)])) # Previous census year
PreviousCens <- Data[get(Time) == PreviousTime]

# IdTree's alive at the previous census, in the plot and subplot in common between last and previous census
PreviousCensPlot <- unique(Data[,get(Plot)]) # unique(Data[,c(Plot), with = FALSE])
PreviousCensSubPlot <- 
  
  PrevIDs <- unique(PreviousCens[get(LifeStatus)== TRUE, get(IdTree)])

PrevIDs <- unique(PreviousCens$idTree[PreviousCens$CodeAlive == 1 & PreviousCens$Plot %in% plot & 
                                        PreviousCens$SubPlot %in% subplot])

unsighted <- PrevIDs[!PrevIDs %in% LastCens$idTree[!is.na(LastCens$idTree)]]

info <- c("Plot","SubPlot","TreeFieldNum","Xfield","Yfield", "idTree")

if(length(unsighted) > 0){
  unsighted_trees <- PreviousCens[PreviousCens$idTree %in% unsighted & PreviousCens$CodeAlive == TRUE, info]
  unsighted_trees[,names(LastCens)[!names(LastCens) %in% names(unsighted_trees)]] <- NA
  unsighted_trees$to_check <- TRUE
  unsighted_trees$apurement_codes <- "unseen"
  unsighted_trees$comments <- "Arbre oublie/non vu"
  LastCens <- rbind(LastCens,unsighted_trees[,names(LastCens)]) 
}
row.names(LastCens) <- NULL
```


## Check invariant columns
```{r}
# "Plot","SubPlot","TreeFieldNum","X","Y"

```

# Internals

## Bota
## Life status
## Diameter
## Recruitment

