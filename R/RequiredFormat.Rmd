---
title: "RequiredFormat"
author: "Vincyane Badouard"
date: "04/11/2021"
output: html_document
---

# Data import

+ 1000 individuals
+ Several plots
+ Several census 
+ No specific format
```{r}
library(data.table)

ParacouSubset <- fread("D:/VSC TmFO/Data/ParacouSubset.csv")

Acre_site <- fread("D:/VSC TmFO/Data/Acre_site_Marcus - Copie.csv")

Guarani_site <- fread("D:/VSC TmFO/Data/Guarani_site.csv")

Mbaiki_site <- fread("D:/VSC TmFO/Data/Mbaiki_site.csv", encoding = "UTF-8")

BarroColoradoFull <- fread("D:/VSC TmFO/Data/Barro Colorado_data/FullMeasurementBCI/Barro Colorado_fulldata.tsv")
summary(BarroColoradoFull)

length(unique(BarroColoradoFull$TreeID))
length(unique(BarroColoradoFull$PlotCensusNumber)) # census number
sort(unique(BarroColoradoFull$QuadratName))
length(unique(BarroColoradoFull$QuadratName))
length(unique(BarroColoradoFull$QuadratID))
length(sort(unique(BarroColoradoFull$ExactDate))) # "IDate" "Date" class (package lubridate)

# 18 censuses: 1981-2016
# 1981 1982 1983 1985 1990 1991 1992 1995 1996 2000 2001 2005 2006 2010 2011 2013 2015 2016
# 8 census
# 1251 quadrats
# 423617 TreeID
# 1 < DBH < 8169
# 0.2 < HOM < 15.9, standard: 1.3

BarroColoradoSubset <- copy(BarroColoradoFull)
BarroColoradoSubset[, Year := as.numeric(format(ExactDate, "%Y"))]
length(sort(unique(BarroColoradoSubset$Year))) # 18 years

truc <- BarroColoradoSubset[QuadratName == 0]

sort(unique(truc[truc$QuadratName == "0",]$Year)) # 1982 1985 1990 1991 1995 2000 2005 2010 2015
sort(unique(truc[truc$QuadratName == "1",]$Year)) # 1982 1985 1990 1991 1995 2000 2005 2010 2015
sort(unique(truc[truc$QuadratName == "2",]$Year)) # 1982 1985 1990 1991 1995 2000 2005 2010 2015
sort(unique(truc[truc$QuadratName == "3",]$Year)) # 1982 1985 1990 1991 1995 2000 2005 2010 2015

```
# Package data

## Paracou subset
- Plot 6
- SubPlot 1
- 2016-2020
- 5 last censuses
- 1000 individuals
- 4 dummy sub-sub-squares created for the package to be use as plots

### Long format
```{r}
library(data.table)
library(ggplot2)
Paracou6 <- EcoFoG::Guyafor2df(UID = "Vincyane.Badouard", PWD = "Vincyane973+", Driver = "SQL Server",WHERE="Forest='Paracou' AND Plot='6'")
setDT(Paracou6) # as data.table
Paracou6C1 <- Paracou6[SubPlot == 1]

sort(unique(Paracou6C1$CensusYear))
# 1984 1985 1986 1987 1988 1989 1990 1991 1992 1993 1994 1995 1997 1999 2001 2003 2005 2007 2008 2009 2010 2011 2012 2013 2014 2015 2016 2017 2018 2019 2020

# We select the 5 last censuses 2016-2020

ParacouSubset <- Paracou6C1[CensusYear >= 2016] # 4904 obs

ind <- sample(unique(ParacouSubset$idTree), 1000)

ParacouSubset <- ParacouSubset[idTree %in% ind] # 4854 obs

# 4 sub-sub-squares creation

MaxX <- max(ParacouSubset$Xutm)
MinX <- min(ParacouSubset$Xutm)
MaxY <- max(ParacouSubset$Yutm)
MinY <- min(ParacouSubset$Yutm)

HalfX <- MinX + (MaxX - MinX)/2
HalfY <- MinY + (MaxY - MinY)/2

ParacouSubset[, SubSubPlot := NA_real_]
ParacouSubset[Xutm < HalfX & Yutm > HalfY, SubSubPlot := "1"]
ParacouSubset[Xutm > HalfX & Yutm > HalfY, SubSubPlot := "2"]
ParacouSubset[Xutm < HalfX & Yutm < HalfY, SubSubPlot := "3"]
ParacouSubset[Xutm > HalfX & Yutm < HalfY, SubSubPlot := "4"]

ParacouSubset[, Project := NULL]


ggplot() +
  geom_sf(data = sf::st_as_sf(ParacouSubset[SubSubPlot == "1"], coords = c("Xutm", "Yutm")), col = "blue") +
  geom_sf(data = sf::st_as_sf(ParacouSubset[SubSubPlot == "2"], coords = c("Xutm", "Yutm")), col = "red") +
  geom_sf(data = sf::st_as_sf(ParacouSubset[SubSubPlot == "3"], coords = c("Xutm", "Yutm")), col = "orange") +
  geom_sf(data = sf::st_as_sf(ParacouSubset[SubSubPlot == "4"], coords = c("Xutm", "Yutm")), col = "green")

# usethis::use_data(ParacouSubset, overwrite = TRUE)
data(ParacouSubset)
length(ParacouSubset)
names(ParacouSubset)

```

### In wide format (1 col per census)

```{r}
ParacouSubsetWide <- dcast(ParacouSubset, idTree ~ CensusYear, value.var = "Circ")
OtherCols <- copy(ParacouSubset)
OtherCols[, c("CensusYear", "CensusDate", "CensusDateCertainty","CircCorr", "CorrCode") := NULL]
ParacouSubsetWide <- unique(merge(ParacouSubsetWide, OtherCols, by = "idTree")) #1000 ind -> 1000 rows 
ParacouSubsetWide[, Circ := Circ/100] # cm -> m for the exemple


# usethis::use_data(ParacouSubsetWide, overwrite = TRUE)

```


## Barro Colorado Subset 
+ 3 quadrats (1, 2, 3)
+ 1995-2015
+ 5 last censuses

```{r}

BCplots <- BarroColoradoSubset[QuadratName == 1 | QuadratName == 2 | QuadratName == 3, ]
BarroColoradoSubset <- BCplots[Year >= 1995] # 3829 obs

length(unique(BCcensus$TreeID)) # 872 ind

# write.csv2(BarroColoradoSubset, "D:/VSC TmFO/Data/BarroColoradoSubset.csv")

BarroColoradoSubset <- fread("D:/VSC TmFO/Data/BarroColoradoSubset.csv")

# usethis::use_data(BarroColoradoSubset, overwrite = TRUE)

names(BarroColoradoSubset)

```

# Required inventory format for the package"

+ detection of variables of interest (Plot, SubPlot, time, idTree, status, size, POM, PlotArea, X, Y, ScientificName, VernName, Family, Genus, Species, CommercialSp, TreeHeight)
+ Long format (obs = row, var = col)
+ class, units
+ idtree and other necessary variables creation from the existing

Difference with TmFO format: 
+ no changes in variable names
+ no changes in variable units


```{r}
Data = Paracou_subset
Plot = "Plot"
SubPlot = "SubPlot"
Time = "CensusYear"
IdTree = "idTree"
LifeStatus = "CodeAlive"
Size = "Circ"
SizeUnit = NULL
POM = NULL
POMUnit = NULL
PlotArea = NULL
X = NULL
Y = NULL
ScientificName = NULL
VernName = NULL
Family = NULL
Genus = NULL
Species = NULL
CommercialSp = NULL
TreeHeight = NULL
TreeHeightUnit = NULL

RequiredFormat(Paracou_subset,
               Plot = "Plot",
               SubPlot = "SubPlot",
               Time = "CensusYear",
               IdTree = "idTree",
               LifeStatus = "CodeAlive",
               Size = "Circ",
               SizeUnit = "cm",
               POM = "MeasCode",
               POMUnit = "m",
               PlotArea = "PlotArea",
               X = "Xutm",
               Y = "Yutm",
               ScientificName = NULL,
               VernName = "VernName",
               Family = "Family",
               Genus = "Genus",
               Species = "Species",
               CommercialSp = "CommercialSp",
               TreeHeight = NULL,
               TreeHeightUnit = NULL)

```

```{r}
data(ParacouSubsetWide)
Data = ParacouSubsetWide
Plot = "SubPlot"
SubPlot = "SubSubPlot"
Time = c("2016","2017","2018","2019","2020")
TreeFieldNum = "TreeFieldNum"
IdTree = "idTree"
LifeStatus = "CodeAlive"
Size = "Circ"
SizeUnit = "m"
POM = "MeasCode"
POMUnit = "code" # NULL
PlotArea = "PlotArea"
X = "Xutm"
Y = "Yutm"
ScientificName = "none" # NULL
VernName = "none" # NULL
Family = "Family"
Genus = "Genus"
Species = "Species"
CommercialSp = "CommercialSp"
TreeHeight = "none" # NULL
TreeHeightUnit = "none" # NULL
```

